<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments :: head('Результат теста')}"></head>
<body class="bg-light">
<div th:replace="~{fragments :: header}"></div>

<main class="container py-4">
    <div th:if="${message}" class="alert alert-info" th:text="#{${message}}"></div>

    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body">
            <h2 class="card-title h4 mb-3" th:text="'Результат теста: ' + ${result.test.title}"></h2>
            <div sec:authorize="hasRole('TEACHER')">
                <p class="mb-0"><strong>Студент:</strong>
                    <span th:text="${result.user.firstName + ' ' + result.user.lastName}"></span>
                </p>
            </div>
        </div>
    </div>

    <div class="alert alert-warning" th:if="${result.status.name() == 'WAITING'}">
        <span sec:authorize="hasRole('STUDENT')">Ожидайте проверки теста учителем.</span>
        <span sec:authorize="hasRole('TEACHER')">Проверьте тест, чтобы увидеть полный результат:
            <a th:href="@{'/teacher/results/check/' + ${result.id}}">проверить</a></span>
    </div>

    <div th:if="${result.status.name() != 'WAITING'}" class="card shadow-sm border-0">
        <div class="card-body">
            <p class="fs-5">Баллы:
                <strong th:text="${#numbers.formatDecimal(result.score, 1, 'POINT', 2, 'POINT')}"></strong>
            </p>

            <h3 class="h5" sec:authorize="hasRole('STUDENT')">Вопросы и ваши ответы</h3>
            <h3 class="h5" sec:authorize="hasRole('TEACHER')">Ответы</h3>

            <div class="vstack gap-3 mt-3" th:each="answer : ${result.answers}">
                <div class="border rounded p-3">
                    <p class="fw-semibold" th:text="${answer.question.text}"></p>

                    <div th:if="${answer.question.type.name() == 'OPEN'}">
                        <p class="mb-1">Ответ: <span th:text="${answer.answer}"></span></p>
                        <p class="mb-1" th:if="${!answer.question.manualCheckRequired}">
                            Правильный ответ: <span th:text="${answer.question.correctAnswer}"></span>
                        </p>
                        <p class="mb-1 text-muted" th:if="${answer.question.manualCheckRequired}">
                            Вопрос был проверен учителем
                        </p>
                        <p class="mb-0">Начислено баллов:
                            <span th:text="${answer.pointsAwarded != null ? answer.pointsAwarded : 0}"></span>
                        </p>
                    </div>

                    <div th:if="${answer.question.type.name() == 'CHOICE'}">
                        <ul class="mb-2 list-unstyled">
                            <li th:each="option : ${answer.question.options}">
                                <input type="radio" class="form-check-input me-2" th:if="${answer.question.correctCount == 1}"
                                       th:checked="${answer.selectedOptionIds != null and answer.selectedOptionIds.contains(option.id)}"
                                       disabled>
                                <input type="checkbox" class="form-check-input me-2" th:if="${answer.question.correctCount > 1}"
                                       th:checked="${answer.selectedOptionIds != null and answer.selectedOptionIds.contains(option.id)}"
                                       disabled>
                                <span th:text="${option.text}"
                                      th:classappend="${option.isCorrect ? 'text-success fw-semibold' :
                                      (answer.selectedOptionIds != null and answer.selectedOptionIds.contains(option.id) ? 'text-danger fw-semibold' : '')}">
                                </span>
                            </li>
                        </ul>

                        <p class="mb-0">Начислено баллов:
                            <span th:text="${answer.pointsAwarded != null ? answer.pointsAwarded : 0}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments :: footer}"></div>
</body>
</html>
